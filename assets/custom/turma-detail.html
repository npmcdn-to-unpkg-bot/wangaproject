<link rel="import" href="../components/polymer/polymer.html">


<dom-module id="turma-detail">
    <template>
        <style is="custom-style">
            paper-card{
                width: 50%;
                margin: auto;
                margin-bottom: 2em;
                margin-top: 2em;
            }
        </style>
        
        <iron-ajax 
                   id="turmaDetail"
                   method="get"
                   contentType="application/json"
                   auto
                   on-response="showTurma"
                   last-response="{{turma}}"
                   handle-as="json"
                   >
        </iron-ajax>
        
        <iron-ajax 
                   id="Addturma"
                   method="POST"
                   contentType="application/json"
                   on-response="OKurma"
                   last-response="{{teck}}"
                   handle-as="json"
                   >
        </iron-ajax>
        
        <paper-material>
            <div class="layout horizontal wrap" >
                <paper-card heading="{{turma.name}}">
                    <div class="card-content">
                        <p>Data início: <span>{{turma.inicio_data}}</span></p>
                        <p>Data fim: <span>{{turma.fim_data}}</span></p>
                        <h3>Modalidade: <strong>{{turma.curso.modalidade.name}}</strong></h3>
                        <p>Inscritos: <span>{{part}}</span></p>
                    </div>
                    <div class="card-ations">
                        
                        <paper-button on-tap="participar" id="actButton">{{button_message}}</paper-button>
                    </div>
                </paper-card>
            </div>
        </paper-material>
    </template>
    
</dom-module>

<script>
    Polymer({
        is:'turma-detail',
        getCSRFCookie: function() {
                b = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
                return b ? b.pop() : '';
            },
        ready:function(){
            this.$.turmaDetail.url = "/api/turma/"+this.id+"/";
            this.valide_button();
        },
        showTurma:function(r){
            data = r.detail.response;
            console.log(this.$.turmaDetail.lastResponse);
            for(var i=0; i<data.members.length;i++){
                if(data.members[i].id == this.user_pk){
                    this.valide_button(1);
                }
            }
            this.part = data.members.length;
        },
        participar:function(){
            this.$.Addturma.url = "";
            this.$.Addturma.params ='{"curso":this.id, "id_user":this.user_id}';
            this.$.Addturma.headers=("X-CSRFToken", this.getCSRFCookie());
            this.$.Addturma.generateRequest();
        },
        
        valide_button:function(t){
            if (t == 1) {
                this.$.actButton.disabled =true;
                this.button_message = "Já está inscrito";
                
            }
        },
        nbr:function(){
            return  6;//this.turma.members.length;
        },
        properties:{
            turma:{
                type:Object,
                notify:true
            },
            user_pk:{
                type:Number,
                value:null,
                notify:true,
                reflectToAttribute: true,
            },
            
            id:{
                type:Number,
                notify:true,
                reflectToAttribute: true,
            },
            button_message:{
                type:String,
                value: "Participar",
                notify: true
            },
            part:{
                type:String,
                value:""
            }
            
        }
    });
</script>